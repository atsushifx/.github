# src: ./.github/workflows/ci-common-lint-ghalint.yml
# @(#) : GitHub Actions workflow for ghalint validation
#
# Copyright (c) 2025 atsushifx <https://github.com/atsushifx>
#
# This software is released under the MIT License.
# https://opensource.org/licenses/MIT

name: Common CI Ghalint

# Minimal permissions following security best practices
permissions:
  contents: read

# Reusable workflow trigger
on:
  workflow_call:
    inputs:
      config-file:
        type: string
        default: ".shared/configs/ghalint.yaml"
        description: "Path to ghalint config file"
        required: false
      ghalint-version:
        type: string
        default: "1.5.3"
        description: "ghalint version to install"
        required: false

jobs:
  ghalint:
    name: Lint GitHub Actions workflows
    runs-on: ubuntu-slim
    timeout-minutes: 10

    steps:
      # Step 1: Checkout repository
      - name: Checkout repository
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
        with:
          persist-credentials: false

      # Step 2: Checkout shared configs from atsushifx/.github
      - name: Checkout shared configs
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
        with:
          repository: atsushifx/.github
          ref: releases
          path: .shared
          persist-credentials: false

      # Step 3: Setup ghalint binary with checksum verification
      - name: Setup ghalint
        run: |
          set -euo pipefail

          VERSION="${{ inputs.ghalint-version }}"
          DOWNLOAD_URL="https://github.com/suzuki-shunsuke/ghalint/releases/download/v${VERSION}/ghalint_${VERSION}_linux_amd64.tar.gz"
          CHECKSUM_URL="https://github.com/suzuki-shunsuke/ghalint/releases/download/v${VERSION}/ghalint_${VERSION}_checksums.txt"

          # Download ghalint tarball and checksums
          echo "::group::Downloading ghalint v${VERSION}"
          curl -sSL -o /tmp/ghalint.tar.gz "${DOWNLOAD_URL}"
          curl -sSL -o /tmp/checksums.txt "${CHECKSUM_URL}"
          echo "::endgroup::"

          # Extract expected checksum for Linux AMD64 (exact match to avoid .sbom.json)
          EXPECTED_CHECKSUM=$(grep -w "ghalint_${VERSION}_linux_amd64.tar.gz" /tmp/checksums.txt | head -1 | awk '{print $1}')
          echo "Expected checksum: ${EXPECTED_CHECKSUM}"
          ACTUAL_CHECKSUM=$(sha256sum /tmp/ghalint.tar.gz | awk '{print $1}')
          echo "Actual checksum:   ${ACTUAL_CHECKSUM}"

          # Verify checksum - will exit immediately if verification fails
          echo "::group::Verifying checksum"
          if [ "${ACTUAL_CHECKSUM}" != "${EXPECTED_CHECKSUM}" ]; then
            echo "::error::Checksum verification failed! Downloaded file may be corrupted or tampered."
            echo "::error::Expected: ${EXPECTED_CHECKSUM}"
            echo "::error::Actual:   ${ACTUAL_CHECKSUM}"
            exit 1
          fi
          echo "âœ“ Checksum verification successful"
          echo "::endgroup::"

          # Extract and install
          echo "::group::Installing ghalint"
          tar -xzf /tmp/ghalint.tar.gz -C /tmp
          sudo install -m 755 /tmp/ghalint /usr/local/bin/ghalint
          echo "::endgroup::"

          # Verify installation
          echo "Installed version:"
          ghalint --version

          # Cleanup
          rm -f /tmp/ghalint.tar.gz /tmp/checksums.txt /tmp/ghalint

      # Step 4: Run ghalint with color output
      - name: Run ghalint
        id: ghalint
        run: |
          mkdir -p .github/report

          set +e
          ghalint run --log-color always -c ${{ inputs.config-file }} 2>&1 | tee .github/report/report.log
          ghalint_status=${PIPESTATUS[0]}
          set -e

          echo "status=${ghalint_status}" >> "$GITHUB_OUTPUT"
          exit "${ghalint_status}"

      # Step 5: Upload error report as artifact (only on failure)
      - name: Upload ghalint report
        if: failure() && steps.ghalint.outputs.status != '0'
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: ghalint-report
          path: .github/report/report.log
          retention-days: 30
